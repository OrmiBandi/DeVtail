{% extends "base.html" %}
{% block content %}
    
    {% if studies %}
    <h2 class="text-xl">스터디 ToDo 리스트</h2>
    
    <form action="" method="GET">
      <label for="study" class="block font-black text-3xl my-4">Study</label>
      <select name="study" id="study">
        {% for study in studies %}
        <option value="{{ study.id }}" {% if request.GET.study == study.id|stringformat:"s" %}selected{% endif %}>
          {{ study.title }}
        </option>
        {% endfor %}
      </select>
      <button type="submit" class="btn btn-sm">조회</button>
    </form>

    <section>
      <h3 class="font-black text-3xl my-4">Member</h3>
      {% if members %}
      {% for study_members in members.values %}
      <ul class="flex overflow-x-auto gap-4">
        {% with request.GET.copy as params %}
        {% if params.study %}
        <li class="text-center">
          <a href="?study={{ params.study }}&user=all">
          <div class="avatar">
            <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
              <img src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
            </div>
          </div>
          <p>ALL</p>
          </a>
        </li>
        {% else %}
        <li class="text-center">
          <a href="?user=all">
            <div class="avatar">
              <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                <img src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
              </div>
            </div>
            <p>ALL</p>
          </a>
        </li>
        {% endif %}
        {% for member in study_members %}
        {% if params.study %}
        <li class="text-center">
          <a href="?study={{ params.study }}&user={{ member.user.id }}">
          <div class="avatar">
            <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
              <img src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
            </div>
          </div>
          <p>{{ member.user.nickname }}</p>
          </a>
        </li>
        {% else %}
        <li class="text-center">
          <a href="?user={{ member.user.id }}">
            <div class="avatar">
              <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                <img src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
              </div>
            </div>
            <p>{{ member.user.nickname }}</p>
          </a>
        </li>
        {% endif %}
        {% endfor %}
        {% endwith %}
      </ul>
      {% endfor %}
      {% else %}
      <p>멤버가 없습니다.</p>
      {% endif %}
      {% endif %}
    </section>

    <section>
      <div class="flex gap-4 items-center my-4">
        <h3 class="font-black text-3xl">ToDo</h3>
        {% if studies %}
        {% if request.GET.study %}
        <button onclick="location.href='{% url "study_todo_create" study_id=request.GET.study %}'" class="btn btn-sm btn-outline btn-primary">+ 추가</button>
        {% else %}
        <button onclick="location.href='{% url "study_todo_create" study_id=1 %}'" class="btn btn-sm btn-outline btn-primary">+ 추가</button>
        {% endif %}
        
        {% else %}
        <button onclick="location.href='{% url "personal_todo_create" %}'" class="btn btn-sm btn-outline btn-primary">+ 추가</button>
        {% endif %}
      </div>
      <ul class="flex">
        <li class="w-1/3">
          <h4 class="text-center font-black text-xl4 text-primary border-4 border-base-200 text-2xl p-4">Todo</h4>
          {% if todos %}
          <ul class="overflow-y-auto bg-base-200 h-96 p-4">
            {% for todo in todos %}
            {% if todo.status == 'ToDo' %}
            <li class="card bg-base-100 shadow hover:shadow-lg mb-4">
              <div class="card-body p-4">
                <a href="{% url 'todo_detail' todo.id %}" class="link link-hover">
                  <h2 class="card-title">{{ todo.title }}</h2>
                  <p class="truncate">{{ todo.content }}</p>
                </a>
              </div>
              <div class="card-footer p-4 pt-0">
                <div class="flex items-center gap-2">
                  <div class="avatar-group -space-x-6 rtl:space-x-reverse">
                    {% for assignee in todo.todo_assignees.all %}
                    {% if forloop.counter <= 2 %} <div class="avatar">
                      <div class="w-8">
                        <img src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
                      </div>
                  </div>
                  {% endif %}
                  {% endfor %}
                  
                  {% if todo.todo_assignees.count > 2 %}
                  <div class="avatar placeholder">
                    <div class="w-8 bg-neutral text-neutral-content">
                      <span>+{{ todo.todo_assignees.count|add:"-2" }}</span>
                    </div>
                  </div>
                  {% endif %}
                  </div>
                  <div class="flex-1">
                    <p class="text-gray-500">
                      {% for assignee in todo.todo_assignees.all %}
                        {% if forloop.counter <= 2 %}
                          {{ assignee.assignee.nickname }}
                          {% if not forloop.last %}, {% endif %} 
                        {% endif %}
                      {% endfor %}
                        {% if todo.todo_assignees.count > 2 %}
                        외 <span class="font-black text-primary">+{{ todo.todo_assignees.count|add:"-2" }}</span>명
                        {% endif %}
                    </p>
                    <p class="text-gray-500">
                      {% if todo.start_at %}
                      {{ todo.start_at|date:"y/m/d H:i" }} ~ {{ todo.end_at|date:"y/m/d H:i" }}
                      {% endif %}
                    </p>
                  </div>
                  <details class="dropdown dropdown-top dropdown-end">
                    <summary tabindex="0" role="button" class="btn btn-ghost m-1"><span class="sr-only">Open
                        options</span>
                      <svg xmlns="http://www.w3.org/2000/svg" transform="rotate(90)" viewBox="0 0 20 20" fill="currentColor"
                        aria-hidden="true" class="w-4 sb">
                        <path
                          d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z">
                        </path>
                      </svg>
                    </summary>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-md rounded-box border bg-base-100 w-52">
                      <li>
                        {% if todo.study %}
                        <a href="{% url 'study_todo_edit' study_id=todo.study.id pk=todo.id %}">수정하기</a>
                        {% else %}
                        <a href="{% url 'personal_todo_edit' todo.id %}">수정하기</a>
                        {% endif %}
                      </li>
                      <li><a href="{% url 'todo_delete' todo.id %}">삭제하기</a></li>
                    </ul>
                  </details>
                </div>
              </div>
            </li>
            {% endif %}
            {% endfor %}
          </ul>
          {% endif %}
        </li>
        <li class="w-1/3">
          <h4 class="text-center font-black text-xl4 text-primary border-4 border-base-200 text-2xl p-4">In Progress</h4>
          {% if todos %}
          <ul class="overflow-y-auto bg-base-200 h-96 p-4">
            {% for todo in todos %}
            {% if todo.status == 'In Progress' %}
            <li class="card bg-base-100 shadow hover:shadow-lg mb-4">
              <div class="card-body p-4">
                <a href="{% url 'todo_detail' todo.id %}" class="link link-hover">
                  <h2 class="card-title">{{ todo.title }}</h2>
                  <p class="truncate">{{ todo.content }}</p>
                </a>
              </div>
              <div class="card-footer p-4 pt-0">
                <div class="flex items-center gap-2">
                  <div class="avatar-group -space-x-6 rtl:space-x-reverse">
                    {% for assignee in todo.todo_assignees.all %}
                    {% if forloop.counter <= 2 %} <div class="avatar">
                      <div class="w-8">
                        <img src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
                      </div>
                  </div>
                  {% endif %}
                  {% endfor %}
                  
                  {% if todo.todo_assignees.count > 2 %}
                  <div class="avatar placeholder">
                    <div class="w-8 bg-neutral text-neutral-content">
                      <span>+{{ todo.todo_assignees.count|add:"-2" }}</span>
                    </div>
                  </div>
                  {% endif %}
                  </div>
                  <div class="flex-1">
                    <p class="text-gray-500">
                      {% for assignee in todo.todo_assignees.all %}
                      {% if forloop.counter <= 2 %} {{ assignee.assignee.nickname }} {% if not forloop.last %}, {% endif %} 
                      {% endif %} {% endfor %} {% if todo.todo_assignees.count > 2 %}
                        외 <span class="font-black text-primary">+{{ todo.todo_assignees.count|add:"-2" }}</span>명
                        {% endif %}
                    </p>
                    <p class="text-gray-500">
                      {% if todo.start_at %}
                      {{ todo.start_at|date:"y/m/d H:i" }} ~ {{ todo.end_at|date:"y/m/d H:i" }}
                      {% endif %}
                    </p>
                  </div>
                  <details class="dropdown dropdown-top dropdown-end">
                    <summary tabindex="0" role="button" class="btn btn-ghost m-1"><span class="sr-only">Open
                        options</span>
                      <svg xmlns="http://www.w3.org/2000/svg" transform="rotate(90)" viewBox="0 0 20 20" fill="currentColor"
                        aria-hidden="true" class="w-4 sb">
                        <path
                          d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z">
                        </path>
                      </svg>
                    </summary>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-md rounded-box border bg-base-100 w-52">
                      <li>
                        {% if todo.study %}
                        <a href="{% url 'study_todo_edit' study_id=todo.study.id pk=todo.id %}">수정하기</a>
                        {% else %}
                        <a href="{% url 'personal_todo_edit' todo.id %}">수정하기</a>
                        {% endif %}
                      </li>
                      <li><a href="{% url 'todo_delete' todo.id %}">삭제하기</a></li>
                    </ul>
                  </details>
                </div>
              </div>
            </li>
            {% endif %}
            {% endfor %}
          </ul>
          {% endif %}
        </li>
        <li class="w-1/3"> 
          <h4 class="text-center font-black text-xl4 text-primary border-4 border-base-200 text-2xl p-4">Done</h4>
          {% if todos %}
          <ul class="overflow-y-auto bg-base-200 h-96 p-4">
            {% for todo in todos %}
            {% if todo.status == 'Done' %}
            <li class="card bg-base-100 shadow hover:shadow-lg mb-4">
              <div class="card-body p-4">
                <a href="{% url 'todo_detail' todo.id %}" class="link link-hover">
                  <h2 class="card-title">{{ todo.title }}</h2>
                  <p class="truncate">{{ todo.content }}</p>
                </a>
              </div>
              <div class="card-footer p-4 pt-0">
                <div class="flex items-center gap-2">
                  <div class="avatar-group -space-x-6 rtl:space-x-reverse">
                    {% for assignee in todo.todo_assignees.all %}
                    {% if forloop.counter <= 2 %} <div class="avatar">
                      <div class="w-8">
                        <img src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
                      </div>
                  </div>
                  {% endif %}
                  {% endfor %}
            
                  {% if todo.todo_assignees.count > 2 %}
                  <div class="avatar placeholder">
                    <div class="w-8 bg-neutral text-neutral-content">
                      <span>+{{ todo.todo_assignees.count|add:"-2" }}</span>
                    </div>
                  </div>
                  {% endif %}
                </div>
                <div class="flex-1">
                  <p class="text-gray-500">
                    {% for assignee in todo.todo_assignees.all %}
                    {% if forloop.counter <= 2 %}
                      {{ assignee.assignee.nickname }}
                      {% if not forloop.last %}, {% endif %}
                      {% endif %}
                    {% endfor %}
                    {% if todo.todo_assignees.count > 2 %}
                      외 <span class="font-black text-primary">+{{ todo.todo_assignees.count|add:"-2" }}</span>명
                    {% endif %}
                  </p>
                  <p class="text-gray-500">
                    {% if todo.start_at %}
                    {{ todo.start_at|date:"y/m/d H:i" }} ~ {{ todo.end_at|date:"y/m/d H:i" }}
                    {% endif %}
                  </p>
                </div>
                <details class="dropdown dropdown-top dropdown-end">
                  <summary tabindex="0" role="button" class="btn btn-ghost m-1"><span class="sr-only">Open
                      options</span>
                    <svg xmlns="http://www.w3.org/2000/svg" transform="rotate(90)" viewBox="0 0 20 20" fill="currentColor"
                      aria-hidden="true" class="w-4 sb">
                      <path
                        d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z">
                      </path>
                    </svg>
                  </summary>
                  <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-md rounded-box border bg-base-100 w-52">
                    <li>
                      {% if todo.study %}
                      <a href="{% url 'study_todo_edit' study_id=todo.study.id pk=todo.id %}">수정하기</a>
                      {% else %}
                      <a href="{% url 'personal_todo_edit' todo.id %}">수정하기</a>
                      {% endif %}
                    </li>
                    <li><a href="{% url 'todo_delete' todo.id %}">삭제하기</a></li>
                  </ul>
                </details>
              </div>
              </div>
            </li>
            {% endif %}
            {% endfor %}
          </ul>
          {% endif %}
        </li>
      </ul>
    </section>
{% endblock %}